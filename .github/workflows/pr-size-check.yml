name: PR Size Checker

on:
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-pr-size:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Calculate PR size
        id: size
        run: |
          # Get the base and head commits
          BASE_COMMIT=${{ github.event.pull_request.base.sha }}
          HEAD_COMMIT=${{ github.event.pull_request.head.sha }}
          
          # Calculate lines changed (additions + deletions)
          LINES_CHANGED=$(git diff --shortstat $BASE_COMMIT $HEAD_COMMIT | grep -Eo '[0-9]+ files? changed' | grep -Eo '[0-9]+' | head -1 || echo "0")
          ADDITIONS=$(git diff --shortstat $BASE_COMMIT $HEAD_COMMIT | grep -Eo '[0-9]+ insertion' | grep -Eo '[0-9]+' | head -1 || echo "0")
          DELETIONS=$(git diff --shortstat $BASE_COMMIT $HEAD_COMMIT | grep -Eo '[0-9]+ deletion' | grep -Eo '[0-9]+' | head -1 || echo "0")
          
          # Calculate total lines changed
          TOTAL_LINES=$((ADDITIONS + DELETIONS))
          
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          
          echo "Files changed: $LINES_CHANGED"
          echo "Additions: $ADDITIONS"
          echo "Deletions: $DELETIONS"
          echo "Total lines changed: $TOTAL_LINES"

      - name: Comment on PR if size is 2000 or more
        if: steps.size.outputs.total_lines >= 2000
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { total_lines, additions, deletions } = process.env
            const message = `
            ##  PR Size Warning
            
            This pull request is quite large with **${total_lines} lines** changed.
            
            - **Additions**: ${additions} lines
            - **Deletions**: ${deletions} lines
            
            Please consider breaking this PR into smaller, more focused pull requests to:
            - Make code review easier and more thorough
            - Reduce the chance of introducing bugs
            - Improve collaboration and feedback
            
            Thank you for your contribution! 
            `
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
        env:
          total_lines: ${{ steps.size.outputs.total_lines }}
          additions: ${{ steps.size.outputs.additions }}
          deletions: ${{ steps.size.outputs.deletions }}