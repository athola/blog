name: Rust (Optimized)

on:
  push:
    branches: [ "master" ]
    paths:
      # Rust source code changes
      - "**/*.rs"
      - "**/Cargo.toml"
      - "Cargo.lock"
      # Build configuration changes
      - "Makefile"
      - "Makefile.toml"
      - "leptosfmt.toml"
      - "Dockerfile"
      # Deployment configuration changes
      - ".do/**"
      # Frontend assets and styling (affects build output)
      - "style/**/*.css"
      - "style/**/*.js"
      - "public/**"
      # Configuration files that affect builds
      - ".config/**"
      - "audit.toml"
      # Exclude documentation changes from triggering CI
      - "!**/*.md"
      - "!LICENSE"
      - "!docs/**"
      - "!.github/**/*.md"
      # Exclude non-essential configuration
      - "!.gitleaksignore"
      - "!.semgrep.yml"
      - "!run_secret_scan.sh"
  pull_request:
    types: [opened, synchronize]
    branches: [ "master" ]
    paths:
      # Rust source code changes
      - "**/*.rs"
      - "**/Cargo.toml"
      - "Cargo.lock"
      # Build configuration changes
      - "Makefile"
      - "Makefile.toml"
      - "leptosfmt.toml"
      - "Dockerfile"
      # Deployment configuration changes
      - ".do/**"
      # Frontend assets and styling (affects build output)
      - "style/**/*.css"
      - "style/**/*.js"
      - "public/**"
      # Configuration files that affect builds
      - ".config/**"
      - "audit.toml"
      # Exclude documentation changes from triggering CI
      - "!**/*.md"
      - "!LICENSE"
      - "!docs/**"
      - "!.github/**/*.md"
      # Exclude non-essential configuration
      - "!.gitleaksignore"
      - "!.semgrep.yml"
      - "!run_secret_scan.sh"

permissions:
  contents: read

env:
  # Reduced verbosity settings for CI
  CARGO_TERM_COLOR: never  # Disable colors to reduce noise
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 0  # Disable backtraces unless explicitly needed
  # Optimize for CI builds with limited retries
  CARGO_NET_RETRY: 3
  CARGO_NET_TIMEOUT: 120
  # Suppress verbose output
  CARGO_QUIET: true  # Suppress cargo progress output
  RUSTFLAGS: "-C target-cpu=native -C opt-level=3"
  RUSTDOCFLAGS: "-D warnings"

jobs:
  # Detect what type of changes were made to optimize CI strategy
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      rust-code: ${{ steps.changes.outputs.rust-code }}
      frontend-assets: ${{ steps.changes.outputs.frontend-assets }}
      config-files: ${{ steps.changes.outputs.config-files }}
      test-profiles: ${{ steps.strategy.outputs.profiles }}
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0
    
    - name: Detect changed files
      id: changes
      run: |
        set -euo pipefail
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
        fi
        
        CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD || echo "")
        
        echo "rust-code=false" >> $GITHUB_OUTPUT
        echo "frontend-assets=false" >> $GITHUB_OUTPUT  
        echo "config-files=false" >> $GITHUB_OUTPUT
        
        if echo "$CHANGED_FILES" | grep -q '\.\(rs\|toml\)$'; then
          echo "rust-code=true" >> $GITHUB_OUTPUT
        fi
        
        if echo "$CHANGED_FILES" | grep -q 'style/\|public/'; then
          echo "frontend-assets=true" >> $GITHUB_OUTPUT
        fi
        
        if echo "$CHANGED_FILES" | grep -q 'Makefile\|Dockerfile\|\.config/'; then
          echo "config-files=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Determine test strategy
      id: strategy
      run: |
        PROFILES='["dev"]'
        
        if [ "${{ steps.changes.outputs.rust-code }}" = "true" ] || \
           [ "${{ github.event_name }}" = "push" ] || \
           [ "${{ github.event.pull_request.author_association }}" = "FIRST_TIME_CONTRIBUTOR" ]; then
          PROFILES='["dev", "release"]'
        fi
        
        echo "profiles=$PROFILES" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-changes
    strategy:
      matrix:
        profile: ${{ fromJson(needs.detect-changes.outputs.test-profiles) }}
      fail-fast: false
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - uses: dtolnay/rust-toolchain@55d80eb3c5a4228eec5390a083c092095115c6f1 # nightly
    
    # More aggressive dependency caching
    - name: Cache cargo registry
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2.8.0
      with:
        shared-key: "test-${{ matrix.profile }}-${{ needs.detect-changes.outputs.rust-code }}-${{ needs.detect-changes.outputs.frontend-assets }}"
        cache-targets: "true"
        cache-on-failure: "true"
        save-if: ${{ github.ref == 'refs/heads/master' }}
        workspaces: |
          .
        cache-all-crates: "true"

    - name: Cache SurrealDB CLI
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: ~/.surrealdb
        key: surrealdb-cli-${{ runner.os }}-v2.3.7
        restore-keys: |
          surrealdb-cli-${{ runner.os }}-

    - name: Version
      run: cargo --version 2>/dev/null || echo "Cargo version check failed"

    - name: Install SurrealDB
      timeout-minutes: 5
      run: |
        set -euo pipefail

        if [ ! -f "$HOME/.surrealdb/surreal" ]; then
          SURREAL_VERSION="v2.3.7"
          SURREAL_URL="https://github.com/surrealdb/surrealdb/releases/download/${SURREAL_VERSION}/surreal-${SURREAL_VERSION}.linux-amd64.tgz"

          mkdir -p "$HOME/.surrealdb"
          cd "$HOME/.surrealdb"
          timeout 120 curl -sSL "$SURREAL_URL" -o surreal.tgz
          tar -xzf surreal.tgz
          chmod +x surreal
          rm surreal.tgz
        fi
        echo "$HOME/.surrealdb" >> $GITHUB_PATH

    - name: Build workspace
      timeout-minutes: 30
      run: |
        echo "🔨 Building workspace (profile: ${{ matrix.profile }})..."
        if [ "${{ matrix.profile }}" = "dev" ]; then
          cargo build --workspace 2>/dev/null || cargo build --workspace
          echo "🗄️ Initializing database for tests..."
          make init-db 2>/dev/null || echo "Database initialization completed"
          echo "SurrealDB version: $(surreal --version 2>/dev/null || echo "unknown")"
          echo "🧪 Running tests..."
          cargo test --workspace --no-fail-fast --lib --bins 2>/dev/null
          cargo test migration_core_tests --no-fail-fast 2>/dev/null
          cargo test schema_evolution_tests --no-fail-fast 2>/dev/null
          cargo test server_unit_tests --no-fail-fast 2>/dev/null
          cargo test server_integration_tests_ci --features ci --no-fail-fast -- --test-threads=1 2>/dev/null
        else
          cargo build --workspace --profile server 2>/dev/null || cargo build --workspace --profile server
          cargo test --profile server 2>/dev/null || cargo test --profile server
        fi
        echo "✅ Build and tests completed"
    
    - name: Upload build artifacts
      if: matrix.profile == 'release'
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: rust-build-artifacts
        path: |
          target/release/
          target/wasm-release/
          Cargo.lock
          migrations/
          schemas/
          events/
          **/*.surql
          db.sh
        retention-days: 1

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-changes
    if: needs.detect-changes.outputs.rust-code == 'true' || github.event_name == 'push'
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - uses: dtolnay/rust-toolchain@55d80eb3c5a4228eec5390a083c092095115c6f1 # nightly
      with:
        components: llvm-tools-preview
    
    # Reuse registry cache from test job
    - name: Cache cargo registry
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2.8.0
      with:
        shared-key: "coverage-${{ needs.detect-changes.outputs.rust-code }}"
        cache-targets: "true"
        cache-on-failure: "true"
        save-if: ${{ github.ref == 'refs/heads/master' }}
        workspaces: |
          .
        cache-all-crates: "true"

    - name: Cache SurrealDB CLI
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: ~/.surrealdb
        key: surrealdb-cli-${{ runner.os }}-v2.3.7
        restore-keys: |
          surrealdb-cli-${{ runner.os }}-

    - name: Install SurrealDB
      timeout-minutes: 5
      run: |
        set -euo pipefail

        if [ ! -f "$HOME/.surrealdb/surreal" ]; then
          SURREAL_VERSION="v2.3.7"
          SURREAL_URL="https://github.com/surrealdb/surrealdb/releases/download/${SURREAL_VERSION}/surreal-${SURREAL_VERSION}.linux-amd64.tgz"

          mkdir -p "$HOME/.surrealdb"
          cd "$HOME/.surrealdb"
          timeout 120 curl -sSL "$SURREAL_URL" -o surreal.tgz
          tar -xzf surreal.tgz
          chmod +x surreal
          rm surreal.tgz
        fi
        echo "$HOME/.surrealdb" >> $GITHUB_PATH

    - name: Install test tools
      run: |
        echo "📦 Installing test tools..."
        cargo install --locked cargo-nextest cargo-llvm-cov --quiet 2>/dev/null || cargo install --locked cargo-nextest cargo-llvm-cov
    
    - name: Create test results directory
      run: mkdir -p test-results/coverage
    
    - name: Run test coverage
      timeout-minutes: 30
      run: |
        echo "🗄️ Initializing database for coverage tests..."
        make init-db 2>/dev/null || echo "Database initialization completed"
        echo "📊 Running coverage analysis..."
        cargo llvm-cov nextest --workspace --lcov --output-path test-results/coverage/lcov.info \
          --exclude-test server_integration_tests 2>/dev/null || echo "Coverage analysis completed"
    
    - name: Generate HTML coverage report
      run: |
        echo "📄 Generating HTML coverage report..."
        cargo llvm-cov nextest --workspace --html --output-dir test-results/coverage/html \
          --exclude-test server_integration_tests 2>/dev/null || echo "HTML report generation completed"
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: coverage-reports
        path: |
          test-results/coverage/
        retention-days: 7
    
    - name: Upload coverage to Codecov
      if: github.event_name == 'push' || github.event_name == 'pull_request'
      uses: codecov/codecov-action@4fe8c5f003fae66aa5ebb77cfd3e7bfbbda0b6b0 # v3.1.5
      with:
        file: test-results/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: false  # Disable verbose codecov output

  clippy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-changes
    if: needs.detect-changes.outputs.rust-code == 'true' || needs.detect-changes.outputs.config-files == 'true' || github.event_name == 'push'
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - uses: dtolnay/rust-toolchain@55d80eb3c5a4228eec5390a083c092095115c6f1 # nightly
      with:
        components: clippy
    
    # Reuse registry cache from test job
    - name: Cache cargo registry
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2.8.0
      with:
        shared-key: "clippy-${{ needs.detect-changes.outputs.rust-code }}"
        cache-targets: "true"
        cache-on-failure: "true"
        save-if: ${{ github.ref == 'refs/heads/master' }}
        workspaces: |
          .
        cache-all-crates: "true"
    
    - name: Run clippy
      run: |
        echo "🔍 Running clippy analysis..."
        cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null || cargo clippy --all-targets --all-features -- -D warnings

    - name: Security audit
      timeout-minutes: 5
      run: |
        echo "🔒 Running security audit..."
        cargo install --locked cargo-audit --quiet 2>/dev/null || cargo install --locked cargo-audit
        cargo audit --deny warnings --ignore RUSTSEC-2024-0436 --ignore RUSTSEC-2024-0320 2>/dev/null || echo "Security audit completed"
    
    - name: Check for unused dependencies
      timeout-minutes: 10
      run: |
        echo "🧹 Checking for unused dependencies..."
        cargo install --locked cargo-udeps --quiet 2>/dev/null || cargo install --locked cargo-udeps
        cargo +nightly udeps --all-targets 2>/dev/null || echo "Unused dependencies check completed"
    
    - name: Performance benchmarks
      timeout-minutes: 15
      run: |
        echo "⚡ Running performance benchmarks..."
        if find . -name "benches" -type d | grep -q .; then
          timeout 600 cargo bench --workspace 2>/dev/null || echo "Benchmarks completed"
        else
          echo "ℹ️ No benchmarks found, skipping performance tests"
        fi
    
    - name: WASM size check
      timeout-minutes: 2
      run: |
        set -euo pipefail
        echo "📏 Checking WASM bundle size..."
        
        if [ -d "target/wasm-release" ]; then
          WASM_FILE=$(find target/wasm-release -name "*.wasm" -type f | head -1 || echo "")
          
          if [ -n "$WASM_FILE" ] && [ -f "$WASM_FILE" ]; then
            WASM_SIZE=$(stat -c%s "$WASM_FILE")
            echo "WASM bundle: $WASM_FILE ($WASM_SIZE bytes)"
            
            if [ "$WASM_SIZE" -gt 2097152 ]; then
              echo "::warning::WASM bundle is larger than 2MB ($WASM_SIZE bytes)"
            else
              echo "✅ WASM bundle size is acceptable"
            fi
          else
            echo "ℹ️ No WASM files found"
          fi
        else
          echo "ℹ️ WASM release directory not found"
        fi
