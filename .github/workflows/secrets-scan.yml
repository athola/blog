name: Security - Secret Scanning

on:
  push:
    branches: [ "master" ]
    # Run on any file changes that could contain secrets
    paths-ignore:
      - 'target/**'
      - 'node_modules/**'
      - '**/*.md'  # Documentation changes generally safe, but we'll scan anyway for examples
  pull_request:
    branches: [ "master" ]
    paths-ignore:
      - 'target/**'
      - 'node_modules/**'
  schedule:
    # Run weekly scans on Sunday at 2 AM UTC for comprehensive security audits
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual triggering

env:
  # Ensure consistent scanning environment
  FORCE_COLOR: 1

jobs:
  secrets-scan:
    name: Scan for secrets and sensitive information
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      with:
        fetch-depth: 0  # Full history for comprehensive scanning
        
    - name: Install secret scanning tools
      run: |
        echo "üîß Installing secret scanning tools..."
        
        # Install gitleaks
        echo "Installing gitleaks..."
        curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz | tar -xz
        sudo mv gitleaks /usr/local/bin/
        gitleaks version
        
        # Install semgrep
        echo "Installing semgrep..."
        python3 -m pip install --upgrade pip
        python3 -m pip install semgrep
        semgrep --version
        
        # Install trufflehog
        echo "Installing trufflehog..."
        curl -sSfL https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_linux_amd64.tar.gz | tar -xz
        sudo mv trufflehog /usr/local/bin/
        trufflehog --version
        
        echo "‚úÖ All scanning tools installed successfully"
        
    - name: Run comprehensive secret scanning
      run: |
        echo "üîç Starting comprehensive secret scanning..."
        chmod +x ./run_secret_scan.sh
        ./run_secret_scan.sh
        
    - name: Analyze scanning results
      id: analyze
      run: |
        echo "üìä Analyzing secret scanning results..."
        
        # Initialize counters
        GITLEAKS_SECRETS=0
        SEMGREP_HIGH=0
        SEMGREP_WARNINGS=0
        
        # Check gitleaks results
        if [ -f secret_scanning_results/gitleaks-report.json ]; then
          if [ -s secret_scanning_results/gitleaks-report.json ] && [ "$(cat secret_scanning_results/gitleaks-report.json)" != "[]" ]; then
            GITLEAKS_SECRETS=$(jq 'length' secret_scanning_results/gitleaks-report.json)
            echo "‚ö†Ô∏è  Gitleaks found $GITLEAKS_SECRETS potential secrets"
          else
            echo "‚úÖ Gitleaks: No secrets detected"
          fi
        fi
        
        # Check semgrep results
        if [ -f secret_scanning_results/semgrep-report.json ]; then
          SEMGREP_HIGH=$(jq '[.results[]? | select(.extra.severity == "ERROR")] | length' secret_scanning_results/semgrep-report.json 2>/dev/null || echo "0")
          SEMGREP_WARNINGS=$(jq '[.results[]? | select(.extra.severity == "WARNING")] | length' secret_scanning_results/semgrep-report.json 2>/dev/null || echo "0")
          
          if [ "$SEMGREP_HIGH" -gt 0 ]; then
            echo "‚ùå Semgrep found $SEMGREP_HIGH high-severity issues"
          fi
          if [ "$SEMGREP_WARNINGS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Semgrep found $SEMGREP_WARNINGS warnings"
          fi
          if [ "$SEMGREP_HIGH" -eq 0 ] && [ "$SEMGREP_WARNINGS" -eq 0 ]; then
            echo "‚úÖ Semgrep: No security issues detected"
          fi
        fi
        
        # Set outputs for other steps
        echo "gitleaks_secrets=$GITLEAKS_SECRETS" >> $GITHUB_OUTPUT
        echo "semgrep_high=$SEMGREP_HIGH" >> $GITHUB_OUTPUT
        echo "semgrep_warnings=$SEMGREP_WARNINGS" >> $GITHUB_OUTPUT
        
    - name: Fail on critical secrets
      if: steps.analyze.outputs.gitleaks_secrets != '0' || steps.analyze.outputs.semgrep_high != '0'
      run: |
        echo "üö® Critical security issues detected!"
        echo ""
        
        if [ "${{ steps.analyze.outputs.gitleaks_secrets }}" != "0" ]; then
          echo "‚ùå CRITICAL: Gitleaks detected ${{ steps.analyze.outputs.gitleaks_secrets }} secrets!"
          echo "Secrets found:"
          jq -r '.[] | "  - \(.RuleID): \(.File):\(.StartLine) - \(.Description)"' secret_scanning_results/gitleaks-report.json
          echo ""
        fi
        
        if [ "${{ steps.analyze.outputs.semgrep_high }}" != "0" ]; then
          echo "‚ùå CRITICAL: Semgrep detected ${{ steps.analyze.outputs.semgrep_high }} high-severity issues!"
          echo "Issues found:"
          jq -r '.results[] | select(.extra.severity == "ERROR") | "  - \(.check_id): \(.path):\(.start.line) - \(.extra.message)"' secret_scanning_results/semgrep-report.json
          echo ""
        fi
        
        echo "üí° Please review and fix these security issues before proceeding."
        echo "üí° Use .gitleaksignore for confirmed false positives."
        echo "üí° Update semgrep rules in .semgrep.yml if needed."
        
        exit 1
        
    - name: Generate security summary
      if: always()
      run: |
        echo "## üîí Security Scanning Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.analyze.outputs.gitleaks_secrets }}" = "0" ] && [ "${{ steps.analyze.outputs.semgrep_high }}" = "0" ]; then
          echo "### ‚úÖ Security Status: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No critical security issues detected in this repository." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Security Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Critical security issues detected that require immediate attention." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scan Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Critical Issues | Warnings |" >> $GITHUB_STEP_SUMMARY
        echo "|------|----------------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| üîç Gitleaks | ${{ steps.analyze.outputs.gitleaks_secrets }} secrets | - |" >> $GITHUB_STEP_SUMMARY
        echo "| üîç Semgrep | ${{ steps.analyze.outputs.semgrep_high }} errors | ${{ steps.analyze.outputs.semgrep_warnings }} warnings |" >> $GITHUB_STEP_SUMMARY
        echo "| üîç Trufflehog | See artifacts | - |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Scanning Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- **Gitleaks**: Pattern-based secret detection" >> $GITHUB_STEP_SUMMARY
        echo "- **Semgrep**: Custom security rules (.semgrep.yml)" >> $GITHUB_STEP_SUMMARY  
        echo "- **Trufflehog**: Entropy-based secret detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full scan reports available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
        
    - name: Upload secret scanning results
      uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
      if: always()
      with:
        name: secret-scanning-results-${{ github.run_number }}
        path: secret_scanning_results/
        retention-days: 90  # Keep security reports longer for compliance
        
    - name: Set workflow conclusion
      if: always()
      run: |
        if [ "${{ steps.analyze.outputs.gitleaks_secrets }}" != "0" ] || [ "${{ steps.analyze.outputs.semgrep_high }}" != "0" ]; then
          echo "‚ùå Secret scanning failed - critical issues detected"
          echo "This prevents the workflow from proceeding to protect repository security."
        else
          echo "‚úÖ Secret scanning passed - repository is secure"
          echo "Other workflows can proceed safely."
        fi