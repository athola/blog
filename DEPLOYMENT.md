# Deploying the Blog to DigitalOcean

I spent a weekend figuring out how to deploy this Rust/Leptos blog to DigitalOcean. Here's what actually works, what didn't, and what I'd do differently.

## What This Actually Is

- **App**: Rust/Leptos compiled to WASM, running on DigitalOcean App Platform
- **Database**: SurrealDB 3.0.0-alpha.10 on a separate droplet
- **Domain**: alexthola.com via NameCheap
- **Cost**: ~$17/month ($5 app + $12 droplet)

## What You Need

- DigitalOcean account with billing enabled
- Domain registered at NameCheap (alexthola.com)
- GitHub repository with the code
- `doctl` CLI (optional but helpful)

## Database Setup: SurrealDB Droplet

The app uses SurrealDB, not PostgreSQL. You need to host it yourself.

### Create the Droplet

```
Region: New York (NYC3) - same as your app
Image: Ubuntu 22.04 LTS
Size: $12/mo (2GB RAM, 1 vCPU, 50GB SSD)
Hostname: surrealdb-production
```

### Install SurrealDB

```bash
ssh root@YOUR_DROPLET_IP

# Install SurrealDB
curl -sSf https://install.surrealdb.com | sh
surreal version  # Should show 3.0.0-alpha.10 or later

# Create service user
useradd -r -s /bin/false surrealdb
mkdir -p /var/lib/surrealdb
chown surrealdb:surrealdb /var/lib/surrealdb
chmod 700 /var/lib/surrealdb
```

### Configure the Service

```bash
cat > /etc/systemd/system/surrealdb.service << 'EOF'
[Unit]
Description=SurrealDB Database
After=network.target

[Service]
Type=simple
User=surrealdb
Group=surrealdb
ExecStart=/root/.surrealdb/surreal start \
  --bind 0.0.0.0:8000 \
  --user root \
  --pass YOUR_SECURE_PASSWORD \
  --log info \
  file:/var/lib/surrealdb/data.db

Restart=always
RestartSec=10
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/surrealdb

[Install]
WantedBy=multi-user.target
EOF
```

Replace `YOUR_SECURE_PASSWORD` with something generated by `openssl rand -base64 32`.

```bash
# Start it up
systemctl daemon-reload
systemctl enable surrealdb
systemctl start surrealdb
systemctl status surrealdb
```

### Firewall

```bash
ufw allow 22/tcp  # SSH
# Only allow your app's VPC to access the database
ufw allow from YOUR_APP_VPC_RANGE to any port 8000
ufw enable
```

## App Platform Setup

### Create the App

1. In DigitalOcean, go to **Apps** → **Create App**
2. Connect GitHub, select `athola/blog` repository
3. Select branch: `master`
4. Enable **Autodeploy**
5. DigitalOcean will detect the Dockerfile

### Configure the App

**Name**: `blog-web`
**Region**: New York 3
**Instance Size**: Basic $5/mo
**HTTP Port**: 8080

### Environment Variables

Add these as **encrypted** secrets:

```
RUST_LOG=info
LEPTOS_SITE_ADDR=0.0.0.0:8080
LEPTOS_SITE_ROOT=site
LEPTOS_HASH_FILES=true
SURREAL_ADDRESS=http://YOUR_DROPLET_IP:8000
SURREAL_NS=production
SURREAL_DB=alexthola_blog
SURREAL_USERNAME=root
SURREAL_PASSWORD=YOUR_SECURE_PASSWORD
```

**Important**: Mark `SURREAL_PASSWORD` as encrypted so it doesn't appear in logs.

### Deploy

Click **Create Resources** and wait 10-15 minutes for the build.

## Domain Configuration

### Add Custom Domain

1. In your app settings, click **Domains** → **Add Domain**
2. Enter: `alexthola.com`
3. DigitalOcean will give you DNS records to add

### DNS Setup

**Option A: Use DigitalOcean Nameservers** (what I did)

In NameCheap:
- Go to domain management → **Nameservers**
- Select **Custom DNS**
- Add:
  ```
  ns1.digitalocean.com
  ns2.digitalocean.com
  ns3.digitalocean.com
  ```

In DigitalOcean Networking:
- Add domain: `alexthola.com`
- Add A record: `@` → your app
- Add CNAME: `www` → `@`

**Option B: Keep NameCheap DNS**
Add CNAME records pointing to your DigitalOcean app URL.

## Database Initialization

After the app deploys, you need to initialize the database schema:

```bash
# Set environment variables
export SURREAL_ADDRESS="http://YOUR_DROPLET_IP:8000"
export SURREAL_NS="production"
export SURREAL_DB="alexthola_blog"
export SURREAL_USERNAME="root"
export SURREAL_PASSWORD="YOUR_SECURE_PASSWORD"

# Import schema
surreal sql --conn $SURREAL_ADDRESS --user $SURREAL_USERNAME --pass $SURREAL_PASSWORD --ns $SURREAL_NS --db $SURREAL_DB < migrations/schema.surql
```

## What I Learned

### What Went Wrong

1. **Wrong database engine**: Initially tried to use PostgreSQL, but the app is built for SurrealDB
2. **Build timeouts**: The first builds timed out. Fixed by optimizing the Dockerfile
3. **DNS propagation**: Took longer than expected (about 2 hours)

### What I'd Do Differently

1. **Start with the $12 droplet**: The $5 option kept running out of memory during builds
2. **Set up monitoring earlier**: Had to add alerts after the first outage
3. **Document the actual setup**: The original guide described a completely different architecture

### Costs

| Service | What I Pay |
|---------|------------|
| App Platform (Basic) | $5/mo |
| SurrealDB Droplet | $12/mo |
| Droplet Backups | $2.40/mo |
| **Total** | **~$19/mo** |

### Scaling Triggers

- CPU > 70% sustained → upgrade app instance
- Memory > 80% → upgrade droplet
- Slow queries → add database indexes

## Troubleshooting

### App Won't Start

Check runtime logs in DigitalOcean console or with `doctl apps logs APP_ID --type=run --follow`.

Common issues:
- Missing environment variables
- Database connection failed
- Port binding (must be 0.0.0.0:8080)

### Database Connection Errors

```bash
# Check if SurrealDB is running
ssh root@DROPLET_IP
systemctl status surrealdb
journalctl -u surrealdb -n 50

# Test connection
curl http://DROPLET_IP:8000/health
```

### Domain Not Working

```bash
# Check DNS propagation
dig alexthola.com +short
dig NS alexthola.com +short

# Can take 15 minutes to 48 hours to propagate
```

### Slow Response Times

- Check App Platform metrics (CPU/memory)
- The $5 instance can be slow under load
- Consider upgrading to $10 instance if needed

## Security Setup

### Database Security

- [ ] Strong password (32+ characters)
- [ ] Firewall restricts access to app VPC only
- [ ] Database backups enabled
- [ ] No public database exposure

### App Security

DigitalOcean App Platform includes:
- Automatic HTTPS with Let's Encrypt
- Basic DDoS protection
- Managed runtime environment

### Secrets Management

- Never commit secrets to git
- Use DigitalOcean encrypted environment variables
- Rotate credentials every 90 days

## Maintenance

### Monthly Tasks

- Check monitoring alerts
- Review application logs
- Update dependencies: `cargo update`
- Test backups work

### Quarterly Tasks

- Security audit
- Rotate database password
- Review and optimize costs

## Useful Commands

```bash
# Check app status
doctl apps list
doctl apps get APP_ID

# View logs
doctl apps logs APP_ID --type=run --follow

# Database backup
surreal export --conn $SURREAL_ADDRESS --user $SURREAL_USERNAME --pass $SURREAL_PASSWORD --ns $SURREAL_NS --db $SURREAL_DB backup.surql

# Restart app
doctl apps restart APP_ID
```

## Get Help

If something breaks:

1. Check DigitalOcean app logs
2. Check SurrealDB service status
3. Verify environment variables
4. Open an issue at: https://github.com/athola/blog/issues

---

*Last updated: 2025-11-06*
*What actually works, not what the AI-generated guide said would work.*